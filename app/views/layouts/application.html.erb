<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Primeta.ai" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="description" content="The Fastest Way to Learn From Real-World Codebases">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Sora:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <link rel="icon" href="/icon.png" type="image/png">
    <link rel="icon" href="/icon.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" href="/icon.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag :app, "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body <%= "data-user-admin=true" if user_signed_in? && current_user.admin? %>>
    <header class="main-header">
      <div class="container">
        <div class="logo">
          <%= link_to root_path do %>
            <div class="logo-container">
              <img src="/images/icon.svg" width="28" height="28" alt="Primeta AI" class="logo-icon" />
              <h1>Primeta.ai</h1>
            </div>
          <% end %>
        </div>
        
        <nav class="main-nav">
          <% if user_signed_in? %>
            <%= link_to "Repositories", repositories_path, class: "nav-link #{controller_name == 'repositories' ? 'highlighted' : ''}" %>
            <div class="user-menu" data-controller="dropdown">
              <span class="user-name" data-action="click->dropdown#toggle"><%= current_user.name || current_user.email %></span>
              <div class="dropdown-menu" data-dropdown-target="menu">
                <%= link_to "Profile", my_profile_path %>
                <%= link_to "Settings", edit_user_registration_path %>
                <%= button_to "Sign Out", destroy_user_session_path, method: :delete %>
              </div>
            </div>
          <% else %>
            <%= link_to "Sign In", new_user_session_path, class: "nav-link" %>
            <%= link_to "Sign Up", new_user_registration_path, class: "nav-link" %>
          <% end %>
        </nav>
      </div>
    </header>
    
    <div class="flash-messages">
      <% if notice %>
        <div class="notice"><%= notice %></div>
      <% end %>
      <% if alert %>
        <div class="alert"><%= alert %></div>
      <% end %>
    </div>
    
    <main>
      <%= yield %>
    </main>

    <!-- Primeta -->
    <div class="ai-assistant-container" data-controller="ai-assistant"
         <% if controller_name == 'repository_files' && @repository && @repository_file %>
         data-ai-assistant-repository-id-value="<%= @repository.id %>"
         data-ai-assistant-file-path-value="<%= @repository_file.path %>"
         <% elsif controller_name == 'repositories' && @repository %>
         data-ai-assistant-repository-id-value="<%= @repository.id %>"
         data-ai-assistant-current-repository-value="true"
         <% else %>
         data-ai-assistant-static-info-value="true"
         <% end %>
         data-ai-assistant-is-admin-value="<%= current_user&.admin? || false %>">
      <button class="ai-assistant-toggle" data-action="click->ai-assistant#toggle" title="Toggle AI Assistant">
        <div class="ai-toggle-icon">
          <img src="/images/icon.svg" width="24" height="24" alt="Primeta AI" />
        </div>
        <span class="toggle-label">Primeta AI</span>
      </button>
      <div class="ai-assistant-panel hidden" data-ai-assistant-target="panel">
        <div class="ai-assistant-header">
          <div class="ai-title">
            <div class="ai-icon-small">
              <img src="/images/icon.svg" width="18" height="18" alt="Primeta AI" />
            </div>
            <span>Primeta AI</span>
          </div>
          <button class="close-button" data-action="click->ai-assistant#toggle" title="Close Panel">Ã—</button>
        </div>
        
        <!-- Tab navigation -->
        <div class="ai-assistant-tabs">
          <div class="ai-assistant-tab active" data-tab="context" data-action="click->ai-assistant#switchTab">Context</div>
          <div class="ai-assistant-tab" data-tab="challenges" data-action="click->ai-assistant#switchTab">Challenges</div>
        </div>
        
        <!-- Tab contents -->
        <div class="ai-assistant-content" data-ai-assistant-target="content">
          <!-- Loading indicator -->
          <div class="ai-loading <%= 'hidden' if controller_name != 'repository_files' && (controller_name != 'repositories' || !@repository) %>" data-ai-assistant-target="loadingIndicator">
            <div class="spinner"></div>
            <p>Getting AI insights...</p>
          </div>
          
          <!-- Error message -->
          <div class="ai-error hidden" data-ai-assistant-target="errorMessage"></div>
          
          <!-- Context tab content -->
          <div class="ai-tab-content active" data-tab="context" data-ai-assistant-target="contextContent">
            <% if controller_name != 'repository_files' && (controller_name != 'repositories' || !@repository) %>
              <!-- Static information for non-repository pages -->
              <div class="ai-static-info">
                <h3>About Primeta.ai</h3>
                <p>Primeta.ai is the fastest way to learn from real-world codebases. Our AI-powered platform helps you understand complex code and build your programming knowledge.</p>
                <p>Explore our <a href="/repositories">repository collection</a> to start learning from real code.</p>
              </div>
            <% else %>
              <div class="ai-assistant-placeholder">
                <p>Select a file to get context about it and understand how it fits into the codebase.</p>
              </div>
            <% end %>
          </div>
          
          <!-- Learning Challenges tab content -->
          <div class="ai-tab-content" data-tab="challenges" data-ai-assistant-target="challengesContent">
            <% if controller_name != 'repository_files' && (controller_name != 'repositories' || !@repository) %>
              <!-- Static information for non-repository pages -->
              <div class="ai-static-info">
                <h3>Learning with Primeta</h3>
                <p>Our AI generates tailored coding challenges to test your understanding of the codebase you're exploring.</p>
                <p>Select a file in a repository to start exploring challenges!</p>
              </div>
            <% else %>
              <div class="ai-assistant-placeholder">
                <p>Select a file to explore learning challenges that test your understanding.</p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
    
    <% if controller_name == 'repository_files' && @repository && @repository_file %>
    <script>
      function testAIAssistant() {
        console.log("Direct test of AI Assistant");
        const repoId = <%= @repository.id %>;
        const filePath = "<%= @repository_file.path %>";
        
        // Display a manual loading indicator
        const container = document.createElement('div');
        container.style.position = 'fixed';
        container.style.top = '50%';
        container.style.left = '50%';
        container.style.transform = 'translate(-50%, -50%)';
        container.style.background = '#141440';
        container.style.padding = '20px';
        container.style.borderRadius = '8px';
        container.style.zIndex = '9999';
        container.style.minWidth = '300px';
        container.style.boxShadow = '0 4px 20px rgba(0,0,0,0.5)';
        
        container.innerHTML = `
          <div style="text-align: center; color: white;">
            <div class="spinner" style="
              width: 40px;
              height: 40px;
              border: 4px solid rgba(41, 121, 255, 0.3);
              border-top-color: #2979ff;
              border-radius: 50%;
              animation: spin 1s infinite linear;
              margin: 0 auto 15px auto;
            "></div>
            <p>Fetching context from Gemini API...</p>
          </div>
        `;
        document.body.appendChild(container);
        
        // Make the API call
        const url = `/api/file_context?repository_id=${repoId}&file_path=${encodeURIComponent(filePath)}`;
        console.log("Sending request to:", url);
        
        fetch(url, {
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]')?.content || ''
          }
        })
        .then(response => {
          console.log("Response status:", response.status);
          if (!response.ok) {
            throw new Error(`Failed to fetch file context: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Received data:", data);
          
          // Display the result
          container.innerHTML = `
            <div style="color: white; max-height: 400px; overflow-y: auto;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <h3 style="margin: 0;">File Context</h3>
                <button onclick="document.body.removeChild(this.closest('div').parentNode)" style="background: none; border: none; color: white; cursor: pointer; font-size: 18px;">&times;</button>
              </div>
              <div style="color: rgba(255, 255, 255, 0.9); line-height: 1.5; font-size: 14px;">
                ${formatExplanation(data.explanation)}
              </div>
            </div>
          `;
        })
        .catch(error => {
          console.error('Error fetching file context:', error);
          
          container.innerHTML = `
            <div style="color: white; text-align: center;">
              <p style="color: #ff3b30; margin-bottom: 15px;">Error: ${error.message}</p>
              <button onclick="document.body.removeChild(this.closest('div').parentNode)" style="
                background-color: rgba(41, 121, 255, 0.2);
                color: #2979ff;
                border: 1px solid rgba(41, 121, 255, 0.4);
                padding: 6px 12px;
                border-radius: 4px;
                cursor: pointer;
              ">Close</button>
            </div>
          `;
        });
        
        // Helper function to format text
        function formatExplanation(text) {
          // First handle headings
          let result = text
            .replace(/^#{1}\s+(.*?)$/gm, '<h1 style="font-size: 1.5rem; margin: 1rem 0 0.5rem; color: #fff;">$1</h1>')
            .replace(/^#{2}\s+(.*?)$/gm, '<h2 style="font-size: 1.3rem; margin: 1rem 0 0.5rem; color: #fff;">$1</h2>')
            .replace(/^#{3}\s+(.*?)$/gm, '<h3 style="font-size: 1.1rem; margin: 0.8rem 0 0.4rem; color: #fff;">$1</h3>')
            .replace(/^#{4,6}\s+(.*?)$/gm, '<h4 style="font-size: 1rem; margin: 0.7rem 0 0.3rem; color: #fff;">$1</h4>');
            
          // Then handle other markdown formatting  
          return result
            .replace(/\n\n/g, '<br><br>')
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            .replace(/`(.*?)`/g, '<code style="background-color: rgba(0, 0, 0, 0.2); padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 13px;">$1</code>');
        }
      }
      
      // Add spin animation
      if (!document.getElementById('spin-animation')) {
        const style = document.createElement('style');
        style.id = 'spin-animation';
        style.textContent = `
          @keyframes spin {
            to { transform: rotate(360deg); }
          }
          
          .ai-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            color: rgba(255, 255, 255, 0.7);
            min-height: 100px;
          }
          
          /* Extra hiding class for absolute certainty */
          .ai-loading-hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
            position: absolute !important;
            pointer-events: none !important;
          }
          
          .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(41, 121, 255, 0.3);
            border-top-color: #2979ff;
            border-radius: 50%;
            animation: spin 1s infinite linear;
            margin-bottom: 16px;
          }
          
          .ai-test-button {
            margin-top: 20px;
            text-align: center;
          }
          
          .ai-test-button button {
            background-color: rgba(41, 121, 255, 0.2);
            color: var(--primary-color);
            border: 1px solid rgba(41, 121, 255, 0.4);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
          }
          
          .ai-test-button button:hover {
            background-color: rgba(41, 121, 255, 0.4);
            color: white;
          }
          
          .ai-error {
            padding: 12px;
            background-color: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border-radius: 6px;
            margin-bottom: 16px;
          }
          
          /* Make .hidden work properly */
          .hidden {
            display: none !important;
            visibility: hidden !important;
          }
        `;
        document.head.appendChild(style);
      }
      
      // Add styles for AI assistant
      if (!document.getElementById('ai-assistant-styles')) {
        const style = document.createElement('style');
        style.id = 'ai-assistant-styles';
        style.textContent = `
          /* AI Assistant Panel Styles */
          .ai-assistant-container {
            position: fixed;
            z-index: 1000;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
          }
          
          .ai-assistant-toggle {
            background-color: #2979ff;
            color: white;
            border: none;
            border-radius: 50px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
          }
          
          .ai-assistant-toggle:hover {
            background-color: #0052cc;
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
          }
          
          .ai-assistant-panel {
            background-color: #141440;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
            width: 350px;
            max-width: 90vw;
            max-height: 80vh;
            margin-bottom: 16px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
          }
          
          .ai-assistant-header {
            background-color: #0f0f30;
            color: white;
            padding: 12px 16px;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
          }
          
          .close-button {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
          }
          
          .close-button:hover {
            color: white;
          }
          
          .ai-assistant-content {
            padding: 16px;
            flex: 1;
            overflow-y: auto;
            color: rgba(255, 255, 255, 0.85);
            font-size: 14px;
            line-height: 1.6;
            max-height: 60vh;
          }
          
          .ai-assistant-placeholder {
            color: rgba(255, 255, 255, 0.5);
            text-align: center;
            padding: 20px;
          }
          
          /* AI Context Content Styling */
          .ai-context-content {
            padding: 0 0 16px 0;
          }
          
          .ai-heading {
            font-size: 16px;
            margin: 16px 0 8px 0;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 6px;
          }
          
          .ai-subheading {
            font-size: 15px;
            margin: 14px 0 8px 0;
            color: rgba(255, 255, 255, 0.9);
          }
          
          .ai-bold {
            font-weight: 600;
            color: white;
          }
          
          .ai-italic {
            font-style: italic;
            color: rgba(255, 255, 255, 0.8);
          }
          
          .ai-code {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 2px 5px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 13px;
            color: #f1f1f1;
          }
          
          .ai-list {
            margin: 8px 0;
            padding-left: 20px;
          }
          
          .ai-list-item {
            margin-bottom: 5px;
          }
          
          .refresh-button {
            margin-top: 16px;
            text-align: right;
          }
          
          .refresh-button button {
            background-color: rgba(41, 121, 255, 0.2);
            color: var(--primary-color, #2979ff);
            border: 1px solid rgba(41, 121, 255, 0.4);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
          }
          
          .refresh-button button:hover {
            background-color: rgba(41, 121, 255, 0.4);
            color: white;
          }
          
          /* Extra hiding class for absolute certainty */
          .ai-loading-hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
            position: absolute !important;
            pointer-events: none !important;
          }
          
          /* Make .hidden work properly */
          .hidden {
            display: none !important;
            visibility: hidden !important;
          }
        `;
        document.head.appendChild(style);
      }
    </script>
    <% end %>

    <script>
      // Handle user dropdown menus
      document.addEventListener('DOMContentLoaded', function() {
        document.addEventListener('click', function(e) {
          // Close dropdown menus when clicking outside
          if (!e.target.closest('.user-menu')) {
            document.querySelectorAll('.user-menu').forEach(menu => {
              menu.classList.remove('active');
            });
          }
        });

        // Toggle dropdown on click
        document.querySelectorAll('.user-menu .user-name').forEach(userMenu => {
          userMenu.addEventListener('click', function(e) {
            e.preventDefault();
            const menu = this.closest('.user-menu');
            menu.classList.toggle('active');
          });
        });
      });
    </script>
  </body>
</html>
